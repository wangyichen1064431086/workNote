前段时间，老板交给了我一个任务：通过setTimeout来延后网站复杂资源的请求。

事情是这样的，如果在微信群里分享我站的文章链接，那么群里的人打开该链接会需要等待一定的时间；如果打开文章链接的人想要将文章再分享到朋友圈，那么需要点击微信浏览器右上角的菜单按钮（即横向排列的3个点），然后页面底部弹出菜单选项框，其中包括“分享到朋友圈”，点击即可实现分享；然而有一个问题是，在文章资源完全加载之前（即顶部绿条没有走完之前，也即页面load事件触发之前）,点击右上角按钮所触发的底部菜单框中是没有“分享到朋友圈”选项的。这就有可能会使一部分想要分享文章到朋友圈、却没有耐心等待文章资源在微信浏览器中完全加载的读者，放弃分享文章的行为。

解决该问题的目标很明了，就是要使一些耗时较长的请求全部在load事件之后触发。当然，将耗时较长的请求放在对页面load事件的监听函数中是一个办法；但是这办法的局限性在于，load事件的触发可能会被无限延迟——因为一旦碰上了一个非常大的图片或者其他资源，load事件的触发就会被推后，而那些耗时较长的请求可能有一些是很重要的，依赖load事件的触发显然风险过大。那么就想到了一个办法:setTimeout。

然而，想用setTimeout完美解决问题，也是有非常之多的地方是需要考虑透彻的。本文将从js运行机制开始讲起。

## 1.JavaScript运行机制
### 核心特征：单线程
JavaScript在浏览器中是**单线程**运行的。所谓**单线程**，就是同一时刻只执行一个任务，简单来讲，就是任何时刻JS主线程都只有一句JavaScript代码在运行。

那么为什么JavaScript一定要是单线程呢？如果同时有多个线程运行岂不更强大吗？关于这个问题，在[JavaScript运行机制详解](http://www.ruanyifeng.com/blog/2014/10/event-loop.html)一文中有给出一个通俗易懂的解释：“假定JavaScript同时有两个线程，一个线程在某个DOM节点上添加内容，另一个线程删除了这个节点，这时浏览器应该以哪个线程为准？” 所以，**与用户交互和操作DOM这些主要用途，这决定了JavaScript必须是单线程的**。

### 任务队列
虽然JavaScript每个时刻只能做一个任务，但它并不是只有一个任务需要做。比如它有Ajax回调函数需要执行，它有用于监听click事件的监听函数需要执行，它有setTimeout的函数需要执行...这些在某个时机需要执行的东西，都是JavaScript需要完成的任务；JavaScript主线程当前正在执行的东西，也是它需要完成的一个任务。面对这么多任务，JavaScript一次又只能处理一个任务，用于管理任务执行的**任务队列**就应运而生了。

所有这些任务中首要的当然是那些被主线程顺序执行的一行一行的代码，即**同步任务**。主线程在执行同步任务的过程中，可能会接到未来需要执行某个其他任务的指示。那些未来需要执行的任务，即为**异步任务**。主线程由于手中还没忙完**同步任务**，就只能先把接到的**异步任务**的指示记录下来。

如何记录呢？那就是在合适的时候把相关异步任务推到任务队列中。这里有两点需要理解清楚。第一，并不是马上就把异步任务推到任务队列中，而是在恰当的时机再把异步任务推到队列中，这个时机比如Ajax请求成功返回的时候、click事件触发的时候、setTimeout设置的时间点到了的时候。第二，推到任务队列这个“推到”的动作并不意味着“马上执行”，它只是告诉主线程有这个任务在这里需要被执行，如果主线程有空就赶紧执行，如果主线程现在没有空，那么一旦有空就要考虑执行。

那么对于这个需要执行的任务而言，主线程什么时候才能称得上是有空了呢？第一，主线程已经执行完了同步任务；第二，主线程已经把异步队列中排在该任务之前的任务都执行完了。这时，主线程就可以放心大胆地执行该任务了。当然，该**异步任务**一旦被执行，对于主线程而言也就不再是**异步**而是**同步**的了。


***带插入图片***


除了JS主线程之外，还有一个任务队列
## 参考
setTimeout的那些事：
<http://imweb.io/topic/56ac67fbe39ca21162ae6c78>

JavaScript运行机制详解：
<http://www.ruanyifeng.com/blog/2014/10/event-loop.html>